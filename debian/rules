#!/usr/bin/make -f

export PYBUILD_NAME=pt_os_web_portal
# Override default 'python3-pt-os-web-portal' behaviour
# which comes from building multiple binary packages
export PYBUILD_DESTDIR_python3=debian/pt-os-web-portal/

%:
	dh $@ --buildsystem=pybuild


override_dh_auto_test:
	# Don't run the tests!


override_dh_auto_build:
	npm config set prefix ~/.local

	cd frontend/ && \
		npm install -g yarn && \
		~/.local/bin/yarn install && \
		node_modules/react-scripts/bin/react-scripts.js build && \
		mv build ../pt_os_web_portal/backend/

	npm install -g markdown-styles && \
		mkdir -p ./pt_os_web_portal/backend/static/guides && \
		~/.local/bin/generate-md \
			--layout github \
			--input ./guides \
			--output ./pt_os_web_portal/backend/static/guides

	dh_auto_build

override_dh_clean:
	rm -rf src/frontend/node_modules src/server/onboarding/build src/server/backend/build
	dh_clean

override_dh_installsystemd:
	dh_installsystemd --no-stop-on-upgrade --name=pt-os-web-portal
	dh_installsystemd --no-enable --no-start --name=pt-os-web-portal-port-busy
